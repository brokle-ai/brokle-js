name: Release

on:
  push:
    branches: [main]

concurrency: ${{ github.workflow }}-${{ github.ref }}

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      id-token: write # Required for npm provenance
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Required for changesets

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8.15.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages
        run: pnpm build

      - name: Create Release PR or Publish
        id: changesets
        uses: changesets/action@v1
        with:
          version: pnpm version-packages
          publish: pnpm release
          commit: 'chore: version packages'
          title: 'chore: version packages'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Create Unified GitHub Release
        if: steps.changesets.outputs.published == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const packages = JSON.parse('${{ steps.changesets.outputs.publishedPackages }}');

            if (packages.length === 0) {
              console.log('No packages published, skipping release creation');
              return;
            }

            // All linked packages share the same version
            const version = packages[0].version;
            const tag = `v${version}`;

            console.log(`Creating unified release: ${tag}`);
            console.log(`Packages: ${packages.map(p => p.name).join(', ')}`);

            // Create git tag
            try {
              await github.rest.git.createRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `refs/tags/${tag}`,
                sha: context.sha
              });
              console.log(`✅ Created tag: ${tag}`);
            } catch (error) {
              console.log(`⚠️  Tag ${tag} may already exist: ${error.message}`);
            }

            // Generate release body
            const packageList = packages.map(p =>
              `- **${p.name}** ([npm](https://www.npmjs.com/package/${p.name}/v/${p.version}))`
            ).join('\n');

            const releaseBody = `## Published Packages

${packageList}

## Changes

See individual package CHANGELOGs for detailed changes:
${packages.map(p => `- [${p.name}/CHANGELOG.md](./packages/${p.name.replace('brokle-', 'brokle-')}/CHANGELOG.md)`).join('\n')}

---

**Full Changelog**: https://github.com/${context.repo.owner}/${context.repo.repo}/compare/v${version}...HEAD`;

            // Create GitHub release
            await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: tag,
              name: `v${version}`,
              body: releaseBody,
              draft: false,
              prerelease: version.includes('-alpha') || version.includes('-beta') || version.includes('-rc')
            });

            console.log(`✅ Created unified release: ${tag}`);
