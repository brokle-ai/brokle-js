name: Publish JavaScript SDK

on:
  release:
    types: [published]

jobs:
  publish:
    name: Publish to npm
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Upload artifacts to release
      id-token: write  # npm provenance
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.release.tag_name || github.ref }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8.15.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: 'pnpm'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages
        run: pnpm build

      - name: Validate pre-release version
        if: github.event.release.prerelease
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          if [[ ! "$VERSION" =~ (alpha|beta|rc) ]]; then
            echo "‚ùå ERROR: GitHub Release marked as pre-release but version has no suffix!"
            echo "   Version: $VERSION"
            echo "   This would publish stable version with beta tag, blocking future stable release."
            echo ""
            echo "   To fix: Either"
            echo "   1. Uncheck 'pre-release' checkbox and re-publish, OR"
            echo "   2. Delete this release and create tag with suffix (e.g., v0.1.6-rc.1)"
            exit 1
          fi
          echo "‚úÖ Pre-release version valid: $VERSION"

      - name: Publish to npm (stable)
        if: ${{ !github.event.release.prerelease }}
        env:
          NPM_CONFIG_PROVENANCE: true
        run: |
          echo "üì¶ Publishing package to npm (latest tag)..."
          pnpm publish --access public --no-git-checks --tag latest
          echo "‚úÖ Published to npm!"

      - name: Publish to npm (pre-release)
        if: ${{ github.event.release.prerelease }}
        env:
          NPM_CONFIG_PROVENANCE: true
        run: |
          VERSION="${{ github.event.release.tag_name }}"

          # Extract dist-tag from version suffix
          if [[ "$VERSION" =~ -alpha ]]; then
            TAG="alpha"
          elif [[ "$VERSION" =~ -beta ]]; then
            TAG="beta"
          elif [[ "$VERSION" =~ -rc ]]; then
            TAG="rc"
          else
            TAG="beta"  # Fallback
          fi

          echo "üì¶ Publishing package to npm with @$TAG tag..."
          pnpm publish --access public --no-git-checks --tag $TAG
          echo "‚úÖ Published to npm with @$TAG tag!"
